<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ù„ÙˆØ­Ø© ØªØ³ÙŠÙŠØ± Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</title>

<style>
:root{
  --bg0:#070a12;
  --bg1:#0b1020;
  --card: rgba(255,255,255,.06);
  --line: rgba(255,255,255,.10);

  --text:#eaf0ff;
  --muted: rgba(234,240,255,.70);

  --accent:#7c5cff;
  --warn:#f59e0b;
  --err:#ef4444;

  --radius:18px;
  --shadow: 0 18px 45px rgba(0,0,0,.45);
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  color: var(--text);
  background:
    radial-gradient(1200px 650px at 85% -10%, rgba(124,92,255,.25), transparent 60%),
    radial-gradient(1000px 600px at 10% 0%, rgba(34,197,94,.18), transparent 60%),
    linear-gradient(180deg, var(--bg0), var(--bg1));
  padding: 18px;
}
.container{max-width:1200px;margin:0 auto}

.header{margin-bottom:14px}
.header h1{margin:0;font-size:20px}
.header .sub{margin-top:6px;font-size:13px;color:var(--muted);line-height:1.7}

.card{
  background: var(--card);
  border: 1px solid var(--line);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
  overflow:hidden;
}

.topbar{
  padding:14px;
  border-bottom:1px solid var(--line);
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
}

.btn{
  border:1px solid var(--line);
  background: rgba(0,0,0,.18);
  color: var(--text);
  padding:10px 12px;
  border-radius:14px;
  font-weight:900;
  cursor:pointer;
  transition: transform .08s ease, background .15s ease, border-color .15s ease;
}
.btn:hover{ background: rgba(255,255,255,.06); }
.btn:active{ transform: scale(.98); }
.btn.primary{
  border-color: rgba(124,92,255,.55);
  background: linear-gradient(135deg, rgba(124,92,255,.55), rgba(124,92,255,.15));
}
.btn.danger{
  border-color: rgba(239,68,68,.55);
  background: linear-gradient(135deg, rgba(239,68,68,.35), rgba(239,68,68,.12));
}
.btn.soft{
  border-color: rgba(255,255,255,.14);
  background: rgba(255,255,255,.04);
}
.btn.soft:hover{ background: rgba(255,255,255,.08); }

.searchWrap{flex:1;min-width:240px}
.searchWrap input{
  width:100%;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid var(--line);
  background: rgba(0,0,0,.18);
  color: var(--text);
  outline:none;
}
.searchWrap input:focus{
  border-color: rgba(124,92,255,.6);
  box-shadow: 0 0 0 4px rgba(124,92,255,.14);
}

.pills{margin-inline-start:auto;display:flex;gap:8px;flex-wrap:wrap}

/* ===== Stats Bar ===== */
#statsBar{
  margin-inline-start:auto;
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  align-items:center;
}
.statChip{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:8px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  background: rgba(0,0,0,.18);
  font-size:12px;
  font-weight:900;
  color: var(--text);
  white-space:nowrap;
}
.statChip .k{ color: var(--muted); font-weight:900; }
.statChip .v{ font-weight:900; }
.statChip.ok{ border-color: rgba(34,197,94,.40); }
.statChip.warn{ border-color: rgba(245,158,11,.40); }
.statChip.err{ border-color: rgba(239,68,68,.40); }
.statChip.sync{
  border-color: rgba(124,92,255,.45);
  background: rgba(124,92,255,.10);
}
.statChip .ico{ font-size:14px; line-height:1; }
.statChip.ok .ico{ color:#22c55e; }
.statChip.warn .ico{ color:#f59e0b; }
.statChip.err .ico{ color:#ef4444; }
.statChip.sync .ico{ color:#7c5cff; }

@media (max-width: 650px){
  #statsBar{ width:100%; margin-inline-start:0; }
  .statChip{ flex: 1 1 auto; justify-content:center; }
}

/* ======= Table ======= */
.tableWrap{ overflow:auto; }
table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  min-width: 920px;
}
thead th{
  position:sticky; top:0;
  z-index:5;
  background: rgba(0,0,0,.22);
  color: var(--muted);
  text-align:right;
  font-size:12px;
  font-weight:900;
  padding:12px 12px;
  border-bottom:1px solid var(--line);
}
tbody td{
  padding:12px 12px;
  border-bottom:1px solid rgba(255,255,255,.07);
  white-space:nowrap;
  vertical-align:middle;
}
tbody tr:hover{ background: rgba(255,255,255,.03); }

tr.expired-row{ background: rgba(239,68,68,.10); }
tr.expiring-row{ background: rgba(245,158,11,.08); }
tr.expired-row td:first-child{ box-shadow: inset 4px 0 0 rgba(239,68,68,.85); }
tr.expiring-row td:first-child{ box-shadow: inset 4px 0 0 rgba(245,158,11,.85); }

.badge{
  display:inline-flex;
  align-items:center;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  font-size:12px;
  font-weight:900;
}
.badge.ok{ border-color: rgba(34,197,94,.45); color:#c8f7d9; }
.badge.warn{ border-color: rgba(245,158,11,.45); color:#ffe2b3; }
.badge.err{ border-color: rgba(239,68,68,.45); color:#ffd0d0; }

/* ======= Modals ======= */
.modal{
  position:fixed; inset:0;
  display:none;
  align-items:center; justify-content:center;
  background: rgba(0,0,0,.62);
  z-index:9999;
  padding: 18px;
}
.modal[aria-hidden="false"]{ display:flex; }
.modal .box{
  width:min(860px, 100%);
  background: rgba(10,14,26,.96);
  border: 1px solid rgba(255,255,255,.10);
  border-radius: 22px;
  box-shadow: 0 30px 90px rgba(0,0,0,.65);
  overflow:hidden;
  animation: pop .14s ease-out;
}
@keyframes pop{ from{ transform: translateY(8px); opacity:.0 } to{ transform: translateY(0); opacity:1 } }
.modalHeader{
  padding:14px 16px;
  border-bottom:1px solid rgba(255,255,255,.10);
  display:flex; align-items:center; justify-content:space-between;
  gap:10px;
}
.modalHeader h2{margin:0;font-size:16px}
.modalHeader .hint{color:var(--muted);font-size:12px}
.modalBody{ padding: 14px 16px; }
.modalFooter{
  padding:12px 16px;
  border-top:1px solid rgba(255,255,255,.10);
  display:flex; gap:10px; flex-wrap:wrap;
  justify-content:flex-start;
}

.formGrid{
  display:grid;
  grid-template-columns: 1.2fr 1.2fr .9fr .9fr .9fr .9fr .9fr;
  gap:10px;
}
@media (max-width: 980px){
  table{min-width: 860px}
  .formGrid{ grid-template-columns: 1fr 1fr; }
}
.field label{
  display:block;
  font-weight:900;
  font-size:12px;
  color: var(--muted);
  margin-bottom:6px;
}
.field input, .field select, .field textarea{
  width:100%;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.22);
  color: var(--text);
  outline:none;
}
.field input:focus, .field select:focus, .field textarea:focus{
  border-color: rgba(124,92,255,.6);
  box-shadow: 0 0 0 4px rgba(124,92,255,.14);
}

/* Backup modal layout */
.backGrid{
  display:grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap:10px;
}
@media (max-width: 760px){
  .backGrid{ grid-template-columns: 1fr; }
}
.backTile{
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.03);
  border-radius:18px;
  padding:12px;
}
.backTile .t{font-weight:900;margin-bottom:6px}
.backTile .d{color:var(--muted);font-size:12px;line-height:1.6;margin-bottom:10px}
.backTile .actions{display:flex;gap:10px;flex-wrap:wrap}

.note{
  margin-top:10px;
  border:1px dashed rgba(255,255,255,.14);
  background: rgba(0,0,0,.14);
  border-radius:16px;
  padding:10px 12px;
  color:var(--muted);
  font-size:12px;
  line-height:1.7;
}
.hidden{display:none}

/* ===== Actions Modal (Ù„Ù„Ø¬Ø¯ÙˆÙ„ ÙÙ‚Ø·) ===== */
.actionPill{
  padding:10px 12px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
  color: var(--text);
  font-weight: 900;
  cursor:pointer;
}
.actionPill:hover{ background: rgba(255,255,255,.08); }

.actGrid{
  display:grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap:12px;
}
@media (max-width: 640px){
  .actGrid{ grid-template-columns: 1fr; }
}
.actBtn{
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
  color: var(--text);
  padding: 14px 14px;
  border-radius: 18px;
  font-weight: 900;
  cursor:pointer;
  min-height: 56px;
}
.actBtn:hover{ background: rgba(255,255,255,.08); }
.actBtn:active{ transform: scale(.99); }
.actBtn.danger{
  border-color: rgba(239,68,68,.45);
  background: rgba(239,68,68,.20);
}
.actBtn.danger:hover{ background: rgba(239,68,68,.28); }

/* ===== Sync Modal UI ===== */
.syncSectionTitle{
  font-weight: 900;
  margin: 2px 0 10px;
  color: var(--muted);
}
.syncGrid{
  display:grid;
  grid-template-columns: 1fr;
  gap:12px;
}
.syncBtn{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  padding:16px 14px;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
  color: var(--text);
  font-weight: 900;
  cursor:pointer;
  text-decoration:none;
}
.syncBtn:hover{ background: rgba(255,255,255,.08); }
.syncBtn:active{ transform: scale(.99); }
.syncBtn.link{ cursor:pointer; }


.syncBtn.primary{
  border-color: rgba(124,92,255,.45);
  background: rgba(124,92,255,.10);
}
.syncBtn.danger{
  border-color: rgba(239,68,68,.45);
  background: rgba(239,68,68,.20);
}
.syncBtn.danger:hover{ background: rgba(239,68,68,.28); }


.syncHr{
  height:1px;
  background: rgba(255,255,255,.10);
  margin: 14px 0;
}
.syncNote{
  margin-top: 14px;
  border:1px dashed rgba(255,255,255,.16);
  background: rgba(0,0,0,.16);
  border-radius:16px;
  padding:10px 12px;
  color: var(--muted);
  font-size:12px;
  line-height:1.7;
}

/* ===== Toast ===== */
.toast{
  position: fixed;
  left: 50%;
  bottom: 18px;
  transform: translateX(-50%) translateY(20px);
  min-width: min(520px, calc(100% - 28px));
  max-width: 720px;
  padding: 12px 14px;
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(10,14,26,.92);
  box-shadow: 0 18px 45px rgba(0,0,0,.55);
  color: var(--text);
  font-weight: 900;
  display: flex;
  align-items: center;
  gap: 10px;
  opacity: 0;
  pointer-events: none;
  transition: opacity .18s ease, transform .18s ease;
  z-index: 10000;
}
.toast.show{
  opacity: 1;
  transform: translateX(-50%) translateY(0);
  pointer-events: auto; /* âœ… Ù…Ù‡Ù…: ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„ØªØ±Ø§Ø¬Ø¹ */
}
.toast .ico{ font-size: 16px; }
.toast.err{ border-color: rgba(239,68,68,.45); }
.toast.ok{ border-color: rgba(34,197,94,.40); }
.toast.warn{ border-color: rgba(245,158,11,.40); }
.toast .msg{ font-weight: 900; }
.toast .sub{ color: var(--muted); font-weight: 800; }

/* âœ… Ø²Ø± Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¯Ø§Ø®Ù„ Ø§Ù„ØªÙˆØ³Øª */
.toast .action{
  margin-inline-start: auto;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  color: var(--text);
  padding: 8px 10px;
  border-radius: 12px;
  font-weight: 900;
  cursor: pointer;
}
.toast .action:hover{ background: rgba(255,255,255,.10); }
/* ===== Print Mode ===== */
@media print{
  body{ padding:0 !important; background:#fff !important; color:#000 !important; }
  .container{ max-width:none !important; }
  .topbar, .btn, .toast, .modal{ display:none !important; }
  .card{ box-shadow:none !important; border:0 !important; background:#fff !important; }
  .tableWrap{ overflow:visible !important; }
  table{ min-width:0 !important; width:100% !important; }
  thead th{ position:static !important; background:#fff !important; color:#000 !important; border-bottom:1px solid #ccc !important; }
  tbody td{ border-bottom:1px solid #e5e5e5 !important; }
  tr.expired-row, tr.expiring-row{ background:transparent !important; }
  .printHeader{ display:block !important; }
  a[href]:after{ content:""; }
}
.printHeader{
  display:none;
  padding: 10px 0 14px;
  border-bottom: 1px solid rgba(0,0,0,.15);
  margin-bottom: 10px;
  color:#000;
  font: 14px/1.5 system-ui, Arial;
}
.printHeader .t{ font-weight:900; font-size:16px; }
.printHeader .m{ font-size:12px; opacity:.75; margin-top:4px; }

@media (max-width: 560px){
  .shareGrid{ grid-template-columns: 1fr; }
}
.shareBtn{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  padding:14px 12px;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
  color: var(--text);
  font-weight: 900;
  cursor:pointer;
  text-decoration:none;
  min-height: 52px;
}
.shareBtn:hover{ background: rgba(255,255,255,.08); }
.shareBtn:active{ transform: scale(.99); }
.shareBtn.primary{
  border-color: rgba(124,92,255,.45);
  background: rgba(124,92,255,.10);
}
.shareMini{
  margin-top:10px;
  color: var(--muted);
  font-size:12px;
  line-height:1.7;
  word-break: break-word;
}

</style>

<!-- Firebase (Compat) for Auth UI -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

</head>

<body>
<div class="container">
  <div class="printHeader" id="printHeader">
    <div class="t">ğŸ§¾ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</div>
    <div class="m" id="printMeta">â€”</div>
  </div>
  <div class="header">
    <h1>ğŸ§¾ Ù„ÙˆØ­Ø© ØªØ³ÙŠÙŠØ± Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</h1>
    <div class="sub">âš¡ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù„Ù„ØµÙ + â˜ï¸ Ù†Ø§ÙØ°Ø© Ù…Ø²Ø§Ù…Ù†Ø©/Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ. <span style="opacity:.7;font-weight:800">(v1.4.5)</span></div>
  </div>

  <div class="card">
    <div class="topbar">
      <button class="btn primary" id="openAdd" type="button">â• Ø¥Ø¶Ø§ÙØ©</button>
      <button class="btn soft" id="openBackup" type="button">ğŸ“¦ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</button>
      <button class="btn soft" id="openSync" type="button">â˜ï¸ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</button>
      <button class="btn soft" id="openTotals" type="button">ğŸ’° Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</button>
      <button class="btn soft" id="openAuth" type="button">ğŸ‘¤ Ø­Ø³Ø§Ø¨</button>

      <div class="searchWrap">
        <input id="search" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„..." />
      </div>

      <button class="btn soft" id="shareBtn" type="button">ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ©</button>
      <button class="btn soft" id="printBtn" type="button">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
      <button class="btn danger" id="clearBtn" type="button">Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button>

      <div class="pills" id="statsBar"></div>
    </div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th>Ø§Ù„Ø§Ø³Ù…</th>
            <th>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</th>
            <th>Ø§Ù„Ù…Ø¯Ø©</th>
            <th>Ø§Ù„Ø³Ø¹Ø±</th>
            <th>Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</th>
            <th>Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th>
            <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal: Add/Edit -->
<div class="modal" id="formModal" aria-hidden="true">
  <div class="box" role="dialog" aria-modal="true">
    <div class="modalHeader">
      <div>
        <h2 id="formTitle">Ø¥Ø¶Ø§ÙØ© Ø§Ø´ØªØ±Ø§Ùƒ</h2>
        <div class="hint">Ø§Ù…Ù„Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø«Ù… Ø§Ø¶ØºØ· Ø­ÙØ¸</div>
      </div>
      <button class="btn" id="closeForm" type="button">âœ• Ø¥ØºÙ„Ø§Ù‚</button>
    </div>

    <div class="modalBody">
      <div class="formGrid">
        <div class="field">
          <label>Ø§Ù„Ø§Ø³Ù…</label>
          <input id="name" placeholder="Ù…Ø«Ø§Ù„: Ahmed">
        </div>
        <div class="field">
          <label>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</label>
          <input id="email" placeholder="name@example.com" inputmode="email">
        </div>
        <div class="field">
          <label>Ø§Ø®ØªÙŠØ§Ø± Ø³Ø±ÙŠØ¹</label>
          <select id="quickPlan">
            <option value="">â€” Ø§Ø®ØªØ± â€”</option>
            <option value="1">1 Ø´Ù‡Ø±</option>
            <option value="3">3 Ø£Ø´Ù‡Ø±</option>
            <option value="6">6 Ø£Ø´Ù‡Ø±</option>
            <option value="12">12 Ø´Ù‡Ø±</option>
          </select>
        </div>
        <div class="field">
          <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ù‡Ø± (Ø£ÙŠ Ø±Ù‚Ù…)</label>
          <input id="months" type="number" min="1" step="1" placeholder="Ù…Ø«Ø§Ù„: 2 / 5 / 18">
        </div>

<div class="field">
  <label>Ø§Ù„Ø³Ø¹Ø±</label>
  <input id="price" type="number" min="0" step="0.01" placeholder="Ù…Ø«Ø§Ù„: 9.99">
</div>
        <div class="field">
          <label>Ø§Ù„Ø¹Ù…Ù„Ø©</label>
          <select id="currency">
            <option value="DZD">DZD</option>
            <option value="EUR">EUR</option>
            <option value="USD">USD</option>
            <option value="MAD">MAD</option>
            <option value="TND">TND</option>
          </select>
        </div>
        <div class="field">
          <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</label>
          <input id="start" type="date">
        </div>
        <div class="field">
          <label>ØªÙ†Ø¨ÙŠÙ‡ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ (Ø£ÙŠØ§Ù…)</label>
          <input id="alertDays" type="number" min="1" step="1" placeholder="Ù…Ø«Ø§Ù„: 7">
        </div>
      </div>
    </div>

    <div class="modalFooter">
      <button class="btn primary" id="saveBtn" type="button">ğŸ’¾ Ø­ÙØ¸</button>
      <button class="btn" id="cancelBtn" type="button">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<!-- Modal: Backup -->
<div class="modal" id="backupModal" aria-hidden="true">
  <div class="box" role="dialog" aria-modal="true">
    <div class="modalHeader">
      <div>
        <h2>ğŸ“¦ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</h2>
        <div class="hint">ØªØµØ¯ÙŠØ±/Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON Ùˆ CSV + Ù„ØµÙ‚ JSON</div>
      </div>
      <button class="btn" id="closeBackup" type="button">âœ• Ø¥ØºÙ„Ø§Ù‚</button>
    </div>

    <div class="modalBody">
      <div class="backGrid">
        <div class="backTile">
          <div class="t">â¬‡ï¸ ØªØµØ¯ÙŠØ± JSON</div>
          <div class="d">Ø£ÙØ¶Ù„ Ø®ÙŠØ§Ø± Ù„Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„ÙƒØ§Ù…Ù„.</div>
          <div class="actions">
            <button class="btn soft" id="exportJsonBtn" type="button">ØªØµØ¯ÙŠØ±</button>
          </div>
        </div>

        <div class="backTile">
          <div class="t">â¬†ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù JSON</div>
          <div class="d">Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©.</div>
          <div class="actions">
            <button class="btn soft" id="importFileBtn" type="button">Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù</button>
            <input id="fileInput" type="file" accept="application/json,.json" class="hidden">
          </div>
        </div>

        <div class="backTile">
          <div class="t">ğŸ“‹ Ù„ØµÙ‚ JSON</div>
          <div class="d">Ø§Ù„ØµÙ‚ JSON ÙˆØ§Ø³ØªÙˆØ±Ø¯ Ù…Ø¨Ø§Ø´Ø±Ø©.</div>
          <div class="actions">
            <button class="btn soft" id="openPasteFromBackup" type="button">ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù„ØµÙ‚</button>
          </div>
        </div>

        <div class="backTile">
          <div class="t">â¬‡ï¸ ØªØµØ¯ÙŠØ± CSV</div>
          <div class="d">Ù„Ù„Ø¹Ø±Ø¶ ÙÙŠ Excel (Ù…Ø±Ø§Ø¬Ø¹Ø©).</div>
          <div class="actions">
            <button class="btn soft" id="exportCsvBtn" type="button">ØªØµØ¯ÙŠØ±</button>
          </div>
        </div>

        <div class="backTile">
          <div class="t">â†©ï¸ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¢Ø®Ø± Ø­Ø°Ù</div>
          <div class="d">ÙŠØ¹ÙŠØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø¢Ø®Ø± Ø¹Ù…Ù„ÙŠØ© Ø­Ø°Ù (ØªØ±Ø§Ø¬Ø¹ Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø°Ù Ø¨Ø§Ù„Ø®Ø·Ø£).</div>
          <div class="actions">
            <button class="btn soft" id="restoreLastDeleteBtn" type="button">Ø§Ø³ØªØ±Ø¬Ø§Ø¹</button>
          </div>
        </div>

      </div>

      <div class="note">
        <b>Ù…Ù„Ø§Ø­Ø¸Ø©:</b> Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙŠØªÙ… Ø§Ù„Ø¯Ù…Ø¬ Ø­Ø³Ø¨ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±.
      </div>
    </div>

    <div class="modalFooter">
      <button class="btn" id="closeBackup2" type="button">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<!-- Modal: Paste JSON -->
<div class="modal" id="pasteModal" aria-hidden="true">
  <div class="box" role="dialog" aria-modal="true">
    <div class="modalHeader">
      <div>
        <h2>ğŸ“‹ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ø§Ù„Ù„ØµÙ‚ (JSON)</h2>
        <div class="hint">Ø§Ù„ØµÙ‚ JSON Ø«Ù… Ø§Ø¶ØºØ· Ø§Ø³ØªÙŠØ±Ø§Ø¯</div>
      </div>
      <button class="btn" id="closePaste" type="button">âœ• Ø¥ØºÙ„Ø§Ù‚</button>
    </div>

    <div class="modalBody">
      <div class="field">
        <label>JSON</label>
        <textarea id="pasteArea" rows="10" style="min-height:220px"></textarea>
      </div>
    </div>

    <div class="modalFooter">
      <button class="btn primary" id="doPasteImport" type="button">Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
      <button class="btn" id="cancelPaste" type="button">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<!-- ===== Modal: Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„ ===== -->
<div class="modal" id="rowActionsModal" aria-hidden="true">
  <div class="box" role="dialog" aria-modal="true" style="width:min(740px, 100%)">
    <div class="modalHeader">
      <div>
        <h2>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</h2>
        <div class="hint" id="rowActionsHint">â€”</div>
      </div>
      <button class="btn" id="closeRowActionsX" type="button">âœ•</button>
    </div>

    <div class="modalBody">
      <div class="actGrid">
        <button class="actBtn" id="actExtend" type="button">ğŸ” ØªØ¬Ø¯ÙŠØ¯</button>
        <button class="actBtn" id="actEdit" type="button">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="actBtn" id="actCopyEmail" type="button">ğŸ“‹ Ù†Ø³Ø® Email</button>
        <button class="actBtn danger" id="actDelete" type="button">ğŸ—‘ï¸ Ø­Ø°Ù</button>
      </div>
    </div>

    <div class="modalFooter">
      <button class="btn" id="closeRowActions" type="button">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<!-- ===== Modal: Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ÙˆØ§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ===== -->
<div class="modal" id="syncModal" aria-hidden="true">
  <div class="box" role="dialog" aria-modal="true" style="width:min(760px, 100%)">
    <div class="modalHeader">
      <div>
        <h2>â˜ï¸ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ÙˆØ§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</h2>
        <div class="hint">Ø§Ù„Ù†Ø³Ø® ÙˆØ§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ + Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØªØ®Ø²ÙŠÙ†</div>
      </div>
      <button class="btn" id="closeSyncX" type="button">âœ•</button>
    </div>

    <div class="modalBody">
      <div class="syncSectionTitle">ğŸ‘¥ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©</div>
      <div class="field" style="margin-bottom:12px">
        <label>ÙƒÙˆØ¯ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© (Room)</label>
        <input id="roomCode" placeholder="Ù…Ø«Ø§Ù„: main / team1">
      </div>
      <div class="note" style="margin-top:0;margin-bottom:12px">
        <b>Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ = Ù†ÙØ³ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</b> Ø¨ÙŠÙ† ÙƒÙ„ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù„ÙŠ ØªØ³ØªØ®Ø¯Ù…Ù‡.
      </div>

      <div class="syncSectionTitle">â˜ï¸ Firebase (Ø³Ø­Ø§Ø¨Ø©)</div>

      <div class="syncGrid">
        <button class="syncBtn" id="syncBackupDownload" type="button">â¬†ï¸ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¢Ù† (Ø±ÙØ¹)</button>
        <button class="syncBtn" id="syncBackupShare" type="button">ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ© backup.json</button>
        <button class="syncBtn" id="syncRestorePick" type="button">â¬‡ï¸ Ø¬Ù„Ø¨ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</button>
      </div>

      <div class="note" style="margin-top:10px">
        <b>Live Sync:</b> Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„Ù‡Ø§ØŒ Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„ Ù…Ù† Ø£ÙŠ Ø¬Ù‡Ø§Ø² Ø¯Ø§Ø®Ù„ Ù†ÙØ³ <b>Room</b> ÙŠØ¸Ù‡Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù‡Ù†Ø§ (Ø¨Ø¯ÙˆÙ† Ø³Ø­Ø¨ ÙŠØ¯ÙˆÙŠ).
      </div>

      <div class="syncGrid" style="margin-top:10px">
        <button class="syncBtn primary" id="liveToggleBtn" type="button">ğŸŸ¢ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù„Ø­Ø¸ÙŠØ©</button>
      </div>

      <div class="syncHr"></div>

      <div class="syncSectionTitle">â˜ï¸ Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØªØ®Ø²ÙŠÙ†</div>
      <div class="syncGrid">
        <a class="syncBtn link" href="https://drive.google.com/" target="_blank" rel="noopener">ğŸ“‚ ÙØªØ­ Google Drive</a>
        <a class="syncBtn link" href="https://www.dropbox.com/" target="_blank" rel="noopener">ğŸ“‚ ÙØªØ­ Dropbox</a>
      </div>

      <div class="syncNote">
        <b>Ù…Ù„Ø§Ø­Ø¸Ø©:</b> Ù‡Ø°Ù‡ <b>Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø´ØªØ±ÙƒØ©</b> Ø¹Ø¨Ø± Firebase. Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‚ÙˆØ§Ø¹Ø¯ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØªØ·Ù„Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ Ø§ÙØªØ­ <b>ğŸ‘¤ Ø­Ø³Ø§Ø¨</b> ÙˆØ³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„.
        Ø¥Ø°Ø§ Ø¹Ù…Ù„Øª Ø£ÙˆÙÙ„Ø§ÙŠÙ† Ø³ÙŠØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø±Ø¬ÙˆØ¹ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.
      </div>
    </div>

    <div class="modalFooter">
      <button class="btn" id="closeSync" type="button">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<!-- ===== Modal: Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ (Totals) ===== -->
<div class="modal" id="totalsModal" aria-hidden="true">
  <div class="box" role="dialog" aria-modal="true" style="width:min(760px, 100%)">
    <div class="modalHeader">
      <div>
        <h2>ğŸ’° Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</h2>
        <div class="hint">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù…Ù„Ø© (Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©)</div>
      </div>
      <button class="btn" id="closeTotalsX" type="button">âœ•</button>
    </div>

    <div class="modalBody">
      <div id="totalsBody" class="backTile" style="border-style:solid">
        â€” 
      </div>

      <div class="note" style="margin-top:12px">
        <b>Ù…Ù„Ø§Ø­Ø¸Ø©:</b> Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø­Ù‚Ù„ <b>Ø§Ù„Ø³Ø¹Ø±</b>. Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ø¹Ø± ÙØ§Ø±ØºÙ‹Ø§/0 Ù„Ù† ÙŠÙØ­ØªØ³Ø¨.
      </div>
    </div>

    <div class="modalFooter">
      <button class="btn" id="closeTotals" type="button">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<script>
'use strict';
const APP_VERSION = 'Stage3 â€“ v1.4.5';
const DEBUG = false;
const log = (...a)=>{ if(DEBUG) console.log('[APP]', ...a); };

// ===== Firebase Auth (Stage 1) =====
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyAQPzqeazhj4rjyY1dbcGZ9YEAv8ZhLQbQ",
  authDomain: "dattta-6f497.firebaseapp.com",
  databaseURL: "https://dattta-6f497-default-rtdb.firebaseio.com",
  projectId: "dattta-6f497",
  storageBucket: "dattta-6f497.firebasestorage.app",
  messagingSenderId: "804914291938",
  appId: "1:804914291938:web:7a7d3fe8a5ebb28a306abb"
};

let authReady = false;
let currentUser = null;

function initAuth(){
  try{
    if(!window.firebase || !firebase.initializeApp) return false;
    if(!firebase.apps || firebase.apps.length === 0){
      firebase.initializeApp(FIREBASE_CONFIG);
    }
    const auth = firebase.auth();
    auth.onAuthStateChanged((u)=>{
      currentUser = u || null;
      updateAuthUI();
      try{ restartLiveIfNeeded && restartLiveIfNeeded(); }catch{}
    });
    authReady = true;
    updateAuthUI();
    return true;
  }catch(e){
    authReady = false;
    currentUser = null;
    try{ showToast("ØªØ¹Ø°Ø± ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø­Ø³Ø§Ø¨", String(e?.message || e), "err"); }catch{}
    return false;
  }
}

function updateAuthUI(){
  const t = document.getElementById("authStateText");
  const logoutBtn = document.getElementById("authLogout");
  if(!t || !logoutBtn) return;

  if(!authReady){
    t.textContent = "âš ï¸ Firebase Auth ØºÙŠØ± Ø¬Ø§Ù‡Ø² (ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª/Ø§Ù„Ø§ØªØµØ§Ù„).";
    logoutBtn.disabled = true;
    return;
  }

  if(currentUser){
    t.textContent = `âœ… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„: ${currentUser.email || "â€”"}`;
    logoutBtn.disabled = false;
  }else{
    t.textContent = "ğŸ”’ ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„.";
    logoutBtn.disabled = true;
  }
}


window.addEventListener('error', (e)=>{
  try{ showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØµÙØ­Ø©', (e && e.message) ? e.message : '', 'err'); }catch{}
  log('error', e);
});
window.addEventListener('unhandledrejection', (e)=>{
  try{ showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹', (e && e.reason) ? String(e.reason) : '', 'err'); }catch{}
  log('unhandledrejection', e);
});

const $ = (id)=>document.getElementById(id);
const FIREBASE_URL  = "https://dattta-6f497-default-rtdb.firebaseio.com";

// âœ… Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø´ØªØ±ÙƒØ© (Room) â€” Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ = Ù†ÙØ³ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
const ROOM_KEY = "subs_shared_room_v1";
function sanitizeRoomCode(code){
  return (code||"").toString().trim().toLowerCase()
    .replace(/[^a-z0-9_-]/g,"")
    .slice(0, 32) || "main";
}
function getRoomCode(){
  try{ return sanitizeRoomCode(localStorage.getItem(ROOM_KEY)); }catch{ return "main"; }
}
function setRoomCode(v){
  try{ localStorage.setItem(ROOM_KEY, sanitizeRoomCode(v)); }catch{}
}
function getFirebasePath(){
  return `rooms/${getRoomCode()}/subscriptions`;
}
/* =========================================================

/* =========================================================
   ğŸŸ¢ Stage 3: Live Sync (Realtime Streaming)
   - ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù Ù…Ù† Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
   - ÙŠØ³ØªØ¹Ù…Ù„ Firebase REST Streaming (SSE Ø¹Ø¨Ø± EventSource)
   - Ø¹Ù†Ø¯ Ø£ÙŠ ØªØºÙŠÙŠØ±: Ù†Ø³Ø­Ø¨ Snapshot Ø«Ù… Ù†ÙØ·Ø¨Ù‚ Ù†ÙØ³ Ø¯Ù…Ø¬ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2 (ETag + merge)
========================================================= */
const LIVE_SYNC_KEY = "subs_live_sync_v1";
let liveSource = null;
let liveConnected = false;
let liveDebounce = null;

function isLiveEnabled(){
  try{ return localStorage.getItem(LIVE_SYNC_KEY) === "1"; }catch{ return false; }
}
function setLiveEnabled(on, silent=false){
  try{ localStorage.setItem(LIVE_SYNC_KEY, on ? "1" : "0"); }catch{}
  updateLiveBtn();
  if(on) startLiveListener();
  else stopLiveListener();
  setSyncState(syncState);
  if(!silent){
    try{ showToast(on ? "ğŸŸ¢ ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù„Ø­Ø¸ÙŠØ©" : "â¹ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù„Ø­Ø¸ÙŠØ©", "", "ok"); }catch{}
  }
}

function updateLiveBtn(){
  const b = document.getElementById("liveToggleBtn");
  if(!b) return;
  const on = isLiveEnabled();
  b.textContent = on ? "â¹ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù„Ø­Ø¸ÙŠØ©" : "ğŸŸ¢ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù„Ø­Ø¸ÙŠØ©";
  b.classList.toggle("danger", on);
  b.classList.toggle("primary", !on);
  b.style.opacity = (!navigator.onLine && on) ? ".75" : "1";
}

async function getAuthTokenSafe(){
  try{
    return (currentUser && currentUser.getIdToken) ? await currentUser.getIdToken().catch(()=>null) : null;
  }catch{ return null; }
}

function scheduleLivePull(){
  if(liveDebounce) clearTimeout(liveDebounce);
  liveDebounce = setTimeout(()=>{
    // Ø³Ø­Ø¨ ØµØ§Ù…Øª Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø¯ÙˆÙ† Ø¥Ø²Ø¹Ø§Ø¬
    syncPullNow({silent:true, fromLive:true});
  }, 650);
}

async function startLiveListener(){
  if(!isLiveEnabled()) return;
  if(liveSource) return;

  if(!navigator.onLine){
    liveConnected = false;
    updateLiveBtn();
    setSyncState(syncState);
    return;
  }

  const room = getRoomCode && getRoomCode();
  if(!room){
    setLiveEnabled(false, true);
    try{ showToast("Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Room Ø£ÙˆÙ„Ø§Ù‹", "Ø«Ù… ÙØ¹Ù‘Ù„ Live Sync", "warn"); }catch{}
    return;
  }

  const token = await getAuthTokenSafe();
  const url = new URL(`${FIREBASE_URL}/${getFirebasePath()}.json`);
  if(token) url.searchParams.set("auth", token);

  try{
    liveSource = new EventSource(url.toString());
  }catch(e){
    liveSource = null;
    liveConnected = false;
    setLiveEnabled(false, true);
    try{ showToast("ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Live Sync", String(e?.message||e), "err"); }catch{}
    return;
  }

  const onAny = ()=> scheduleLivePull();

  liveSource.addEventListener("open", ()=>{
    liveConnected = true;
    updateLiveBtn();
    setSyncState(syncState);
  });

  liveSource.addEventListener("error", ()=>{
    // EventSource ÙŠØ­Ø§ÙˆÙ„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
    liveConnected = false;
    updateLiveBtn();
    setSyncState(syncState);
  });

  // Firebase ÙŠØ±Ø³Ù„ put/patch
  liveSource.addEventListener("put", onAny);
  liveSource.addEventListener("patch", onAny);

  // fallback
  liveSource.onmessage = onAny;
}

function stopLiveListener(){
  try{
    if(liveSource){
      liveSource.close();
      liveSource = null;
    }
  }catch{}
  liveConnected = false;
  updateLiveBtn();
  setSyncState(syncState);
}

// Ø¹Ù†Ø¯ ØªØºÙŠÙ‘Ø± Room Ø£Ùˆ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: Ø£Ø¹Ø¯ ØªØ´ØºÙŠÙ„ Live Ø¥Ù† ÙƒØ§Ù†Øª Ù…ÙØ¹Ù„Ø©
function restartLiveIfNeeded(){
  if(!isLiveEnabled()) return;
  stopLiveListener();
  startLiveListener();
}

// Ø±Ø¨Ø· online/offline Ù…Ø¹ Live
window.addEventListener("online", ()=> { if(isLiveEnabled()) startLiveListener(); });
window.addEventListener("offline", ()=> { if(isLiveEnabled()) stopLiveListener(); });
/* âœ… Stage 2: Ø¯Ù…Ø¬ Ø°ÙƒÙŠ + Ø­Ù…Ø§ÙŠØ© ØªØ¹Ø§Ø±Ø¶ (ETag / If-Match)
   - Ù†Ø³ØªØ¹Ù…Ù„ Conditional REST Requests ÙÙŠ Realtime Database
   - Ù†Ù‚Ø±Ø£ ETag Ø¹Ø¨Ø± X-Firebase-ETag: true
   - ÙˆÙ†ÙƒØªØ¨ Ø¨Ø´Ø±Ø· if-match Ù„ØªÙØ§Ø¯ÙŠ "Ø¢Ø®Ø± ÙƒØªØ§Ø¨Ø© ØªÙ…Ø³Ø­ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª"
========================================================= */
const CLOUD_ETAG_PREFIX = "subs_cloud_etag_v2_";
const DEVICE_ID_KEY = "subs_device_id_v1";

function getDeviceId(){
  try{
    let id = localStorage.getItem(DEVICE_ID_KEY);
    if(id) return id;
    id = "dev_" + Date.now().toString(36) + "_" + Math.random().toString(16).slice(2,10);
    localStorage.setItem(DEVICE_ID_KEY, id);
    return id;
  }catch{
    return "dev_" + Date.now().toString(36);
  }
}

function autoDeviceLabel(){
  try{
    const ua = navigator.userAgent || "";
    const plat = navigator.platform || "";
    const isAndroid = /Android/i.test(ua);
    const isIOS = /iPhone|iPad|iPod/i.test(ua);
    const isWin = /Win/i.test(plat) || /Windows/i.test(ua);
    const isMac = /Mac/i.test(plat) && !isIOS;

    const os = isAndroid ? "Android" : isIOS ? "iOS" : isWin ? "Windows" : isMac ? "Mac" : "Device";
    const br = /Edg/i.test(ua) ? "Edge" : /Chrome/i.test(ua) ? "Chrome" : /Firefox/i.test(ua) ? "Firefox" : /Safari/i.test(ua) ? "Safari" : "Browser";
    return `${os}-${br}`;
  }catch{
    return "Device";
  }
}
function getDeviceShort(){
  const id = String(getDeviceId()||"");
  return id.slice(-4).toUpperCase();
}
function getDeviceLabel(){
  // Ø§Ø³Ù… Ø¢Ù„ÙŠ + ØªÙ…ÙŠÙŠØ² Ù‚ØµÙŠØ±
  return `${autoDeviceLabel()} (${getDeviceShort()})`;
}


function getEtagKey(){
  return CLOUD_ETAG_PREFIX + getRoomCode();
}
function loadCloudEtag(){
  try{ return localStorage.getItem(getEtagKey()) || null; }catch{ return null; }
}
function saveCloudEtag(etag){
  try{
    const k = getEtagKey();
    if(!etag) localStorage.removeItem(k);
    else localStorage.setItem(k, etag);
  }catch{}
}

// Ø¢Ø®Ø± ETag Ù…Ø¹Ø±ÙˆÙ Ù„Ù„Ø³Ø­Ø§Ø¨Ø© (Ù„ÙƒÙ„ Room)
let cloudEtag = loadCloudEtag();


const LOCAL_BACKUP_KEY   = "subs_local_backup_v3";
const PENDING_SYNC_KEY   = "subs_pending_sync_v1";

let syncState = "idle"; // idle | saving | ok | fail | offline
let lastSyncAt = null;
let syncTimer = null;

function nowHHMM(){
  const d = new Date();
  return String(d.getHours()).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0");
}

function getSyncText(){
  // Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
  let base = "â€”";
  if(!navigator.onLine) base = "ğŸ“´ Ø£ÙˆÙÙ„Ø§ÙŠÙ†";
  else if(syncState === "saving") base = "â³ Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...";
  else if(syncState === "ok") base = `âœ… ØªÙ…Øª (${lastSyncAt || ""})`;
  else if(syncState === "fail") base = "ğŸ”´ ÙØ´Ù„";

  // Ø­Ø§Ù„Ø© Live Sync (Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3)
  try{
    const on = isLiveEnabled && isLiveEnabled();
    if(on){
      const s = (typeof liveConnected !== "undefined" && liveConnected) ? "ğŸŸ¢ Live" : "ğŸŸ¡ Live";
      base = `${base} Â· ${s}`;
    }
  }catch{}
  return base;
}


function setSyncState(state){
  syncState = state;
  const el = document.getElementById("syncVal");
  if(el) el.textContent = getSyncText();
  const chip = document.getElementById("syncChip");
  if(chip){
    chip.classList.remove("ok","warn","err","syncing","offline");
    if(!navigator.onLine) chip.classList.add("offline");
    else if(state==="saving") chip.classList.add("syncing");
    else if(state==="ok") chip.classList.add("ok");
    else if(state==="fail") chip.classList.add("err");
  }
}

// Fetch Ù…Ø¹ Ù…Ù‡Ù„Ø© + Ù…Ù†Ø¹ Ø§Ù„ÙƒØ§Ø´ (Ø­ØªÙ‰ Ù„Ø§ ÙŠØ¹Ù„Ù‚)
async function fetchWithTimeout(url, options={}, timeoutMs=25000){
  const controller = new AbortController();
  const t = setTimeout(()=>controller.abort(), timeoutMs);
  try{
    return await fetch(url, {
      ...options,
      signal: controller.signal,
      cache: "no-store",
      headers: { ...(options.headers||{}), "Cache-Control":"no-store" }
    });
  } finally { clearTimeout(t); }
}

function markPendingSync(on){
  try{ localStorage.setItem(PENDING_SYNC_KEY, on ? "1" : "0"); }catch{}
}
function hasPendingSync(){
  try{ return localStorage.getItem(PENDING_SYNC_KEY) === "1"; }catch{ return false; }
}

function saveLocalBackup(){
  try{ localStorage.setItem(LOCAL_BACKUP_KEY, JSON.stringify(data)); }catch{}
}
function loadLocalBackup(){
  try{
    const raw = localStorage.getItem(LOCAL_BACKUP_KEY);
    const j = raw ? JSON.parse(raw) : null;
    const rows = Array.isArray(j) ? j : [];
    return rows.map(normalizeRowForMerge).filter(Boolean);
  }catch{ return []; }
}

/* =========================================================
   âœ… Stage 2 Merge Helpers
   - Ø¯Ù…Ø¬ Ø­Ø³Ø¨ (id) Ø«Ù… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø± Ø­Ø³Ø¨ (email)
   - Ø­Ù„ Ø§Ù„ØªØ¹Ø§Ø±Ø¶: Ø¢Ø®Ø± updatedAt ÙŠÙÙˆØ² (Last-write-wins per record)
   - Ø­Ø°Ù: Ù†Ø³ØªØ®Ø¯Ù… tombstone Ø¯Ø§Ø®Ù„ Ø§Ù„Ø³Ø¬Ù„ (deleted=true)
========================================================= */

function _normEmailSafe(e){ return (e||"").toString().trim().toLowerCase(); }

function _ensureUpdatedAt(n){
  const x = Number(n);
  return Number.isFinite(x) && x >= 0 ? x : 0;
}

function _newId(){
  return Date.now()+"_"+Math.random().toString(16).slice(2);
}

function normalizeRowForMerge(r){
  if(!r || typeof r !== "object") return null;
  const out = { ...r };
  out.id = out.id || _newId();
  out.email = _normEmailSafe(out.email);
  out.deleted = !!(out.deleted || out._deleted);
  out.updatedAt = _ensureUpdatedAt(out.updatedAt || out._updatedAt || 0);

  // Ø¨Ø¹Ø¶ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù‚Ø¯ ØªØ®Ø²Ù† Ø§Ù„Ø³Ø¹Ø±/Ø§Ù„Ø£Ø´Ù‡Ø± ÙƒÙ†Øµ
  if(out.months != null){
    const m = Number(out.months);
    out.months = (Number.isFinite(m) && m>0) ? m : 1;
  }
  if(out.price != null){
    const p = Number(out.price);
    out.price = Number.isFinite(p) ? p : 0;
  }
  return out;
}

function mergeRows(localRows, remoteRows){
  const A = Array.isArray(localRows) ? localRows : [];
  const B = Array.isArray(remoteRows) ? remoteRows : [];

  // 1) ØªØ¬Ù…ÙŠØ¹ Ø­Ø³Ø¨ id (Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« ÙŠÙÙˆØ²)
  const byId = new Map();
  const take = (row)=>{
    const r = normalizeRowForMerge(row);
    if(!r) return;
    const prev = byId.get(r.id);
    if(!prev){ byId.set(r.id, r); return; }

    const a = _ensureUpdatedAt(prev.updatedAt);
    const b = _ensureUpdatedAt(r.updatedAt);

    if(b > a) { byId.set(r.id, r); return; }
    if(b < a) return;

    // tie-break: ØºÙŠØ± Ù…Ø­Ø°ÙˆÙ ÙŠÙÙˆØ²
    if(!!prev.deleted && !r.deleted) { byId.set(r.id, r); return; }
  };

  A.forEach(take);
  B.forEach(take);

  let rows = Array.from(byId.values());

  // 2) Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø± Ø­Ø³Ø¨ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ (Ø¥Ù† ÙˆÙØ¬Ø¯)
  const byEmail = new Map(); // email -> winnerId
  for(const r of rows){
    if(!r.email) continue;
    const curWinnerId = byEmail.get(r.email);
    if(!curWinnerId){ byEmail.set(r.email, r.id); continue; }
    const w = rows.find(x=>x.id===curWinnerId);
    if(!w) { byEmail.set(r.email, r.id); continue; }

    const aw = _ensureUpdatedAt(w.updatedAt);
    const ar = _ensureUpdatedAt(r.updatedAt);

    const rBetter = (ar > aw) || (ar === aw && !!w.deleted && !r.deleted);
    if(rBetter){
      byEmail.set(r.email, r.id);
    }
  }

  // Ø§Ø¬Ø¹Ù„ Ø§Ù„Ø®Ø§Ø³Ø±ÙŠÙ† tombstone (deleted=true) Ù…Ø¹ updatedAt >= Ø§Ù„ÙØ§Ø¦Ø²
  const winnerByEmail = new Map();
  for(const [email, id] of byEmail.entries()){
    winnerByEmail.set(email, id);
  }

  rows = rows.map(r=>{
    if(!r.email) return r;
    const winId = winnerByEmail.get(r.email);
    if(!winId || winId === r.id) return r;

    // Ù‡Ø°Ø§ Ù…ÙƒØ±Ø±: Ù†Ø­ÙˆÙ„Ù‡ Ù„Ù…Ø­Ø°ÙˆÙ "ØªÙˆØ¶ÙŠØ­ÙŠ"
    const win = rows.find(x=>x.id===winId);
    const winAt = win ? _ensureUpdatedAt(win.updatedAt) : _ensureUpdatedAt(r.updatedAt);
    return {
      ...r,
      deleted: true,
      updatedAt: Math.max(_ensureUpdatedAt(r.updatedAt), winAt),
      _dupeOf: winId
    };
  });

  // 3) ØªØ±ØªÙŠØ¨: Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹ (Ù…Ø«Ù„ unshift ÙÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©)
  rows.sort((x,y)=> _ensureUpdatedAt(y.updatedAt) - _ensureUpdatedAt(x.updatedAt));

  return rows;
}

function activeOnly(list){
  return (Array.isArray(list) ? list : []).filter(r=> !(r && (r.deleted || r._deleted)) );
}

function buildCloudPayload(rows){
  // Ù†Ø®Ø²Ù† Ø´ÙƒÙ„ Ù…ÙˆØ­Ù‘Ø¯ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© (v2) Ù…Ø¹ rows + meta
  return {
    v: 2,
    updatedAt: Date.now(),
    updatedBy: getDeviceId(),
    updatedByName: getDeviceLabel(),
    rows: Array.isArray(rows) ? rows : []
  };
}

function extractRowsFromCloud(json){
  if(json == null) return [];
  if(Array.isArray(json)) return json;
  if(typeof json === "object"){
    if(Array.isArray(json.rows)) return json.rows;
    if(Array.isArray(json.data)) return json.data; // fallback
  }
  return [];
}

async function firebaseGetJsonWithEtag(){
  const path = getFirebasePath();

  // âœ… Ø¥Ù† ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„: Ø£Ø±Ø³Ù„ Ø§Ù„Ù€ idToken (ÙŠÙ†ÙØ¹ Ù…Ø¹ Ù‚ÙˆØ§Ø¹Ø¯ auth != null)
  const token = (currentUser && currentUser.getIdToken) ? await currentUser.getIdToken().catch(()=>null) : null;
  const authQ = token ? `?auth=${encodeURIComponent(token)}` : "";

  const url = `${FIREBASE_URL}/${path}.json${authQ}`;
  const res = await fetchWithTimeout(url, {
    headers: {
      "X-Firebase-ETag": "true",
      "Cache-Control": "no-store"
    }
  }, 25000);

  if(!res.ok){
    const txt = await res.text().catch(()=> "");
    if(res.status===401 || res.status===403){
      throw new Error(`ØºÙŠØ± Ù…ØµØ±Ø­. Ø§ÙØªØ­ (ğŸ‘¤ Ø­Ø³Ø§Ø¨) ÙˆØ³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ Ø£Ùˆ Ø¹Ø¯Ù‘Ù„ Ù‚ÙˆØ§Ø¹Ø¯ Firebase. (${res.status}) ${txt}`.trim());
    }
    throw new Error(`Firebase pull failed (${res.status}) ${txt}`.trim());
  }

  const etag = res.headers.get("ETag") || res.headers.get("etag") || null;
  const json = await res.json();
  return { json, etag };
}

async function firebasePull(){
  const {json, etag} = await firebaseGetJsonWithEtag();

  // âœ… Ø®Ø²Ù‘Ù† ETag Ù…Ø­Ù„ÙŠÙ‹Ø§ Ù„Ù†ÙØ³ Ø§Ù„Ù€ Room
  cloudEtag = etag || null;
  saveCloudEtag(cloudEtag);

  const rows = extractRowsFromCloud(json);
  // âœ… Ù†Ø¸Ù‘Ù/Ø·Ø¨Ù‘Ø¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª (updatedAt / deleted / email)
  return (rows||[]).map(normalizeRowForMerge).filter(Boolean);
}

async function firebasePushOnce(){
  const path = getFirebasePath();

  // âœ… Ø¥Ù† ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„: Ø£Ø±Ø³Ù„ Ø§Ù„Ù€ idToken (ÙŠÙ†ÙØ¹ Ù…Ø¹ Ù‚ÙˆØ§Ø¹Ø¯ auth != null)
  const token = (currentUser && currentUser.getIdToken) ? await currentUser.getIdToken().catch(()=>null) : null;
  const authQ = token ? `?auth=${encodeURIComponent(token)}` : "";

  const url = `${FIREBASE_URL}/${path}.json${authQ}`;

  // Ø¥Ø°Ø§ Ù„Ø§ Ù†Ù…Ù„Ùƒ ETag Ø¨Ø¹Ø¯: Ø¬Ø±Ù‘Ø¨ null_etag (Ø³ÙŠÙØ´Ù„ Ø¨Ù€ 412 Ø¥Ù† ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ø¨ÙŠØ§Ù†Ø§Øª) Ø«Ù… Ù†Ø¯Ù…Ø¬ ÙˆÙ†ÙØ¹ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
  const ifMatch = cloudEtag || "null_etag";

  const payload = buildCloudPayload(Array.isArray(data) ? data : []);

  const res = await fetchWithTimeout(url, {
    method: "PUT",
    headers: {
      "Content-Type": "application/json",
      "X-Firebase-ETag": "true",
      "if-match": ifMatch
    },
    body: JSON.stringify(payload)
  }, 25000);

  if(!res.ok){
    const txt = await res.text().catch(()=> "");
    if(res.status===401 || res.status===403){
      throw new Error(`ØºÙŠØ± Ù…ØµØ±Ø­. Ø§ÙØªØ­ (ğŸ‘¤ Ø­Ø³Ø§Ø¨) ÙˆØ³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ Ø£Ùˆ Ø¹Ø¯Ù‘Ù„ Ù‚ÙˆØ§Ø¹Ø¯ Firebase. (${res.status}) ${txt}`.trim());
    }

    // âœ… ØªØ¹Ø§Ø±Ø¶ ETag (Ù‡Ù†Ø§Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ù…Ù† Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±)
    if(res.status === 412){
      let remoteJson = null;
      try{ remoteJson = txt ? JSON.parse(txt) : null; }catch{ remoteJson = null; }
      const remoteEtag = res.headers.get("ETag") || res.headers.get("etag") || null;

      const err = new Error("ETag mismatch (merge required)");
      err.code = "etag_mismatch";
      err.remote = remoteJson;
      err.etag = remoteEtag;
      throw err;
    }

    throw new Error(`Firebase push failed (${res.status}) ${txt}`.trim());
  }

  // âœ… ØªØ­Ø¯ÙŠØ« ETag Ø¨Ø¹Ø¯ Ù†Ø¬Ø§Ø­ Ø§Ù„ÙƒØªØ§Ø¨Ø© (Ø¥Ø°Ø§ Ø£ÙØ¹ÙŠØ¯)
  const newEtag = res.headers.get("ETag") || res.headers.get("etag") || null;
  if(newEtag){
    cloudEtag = newEtag;
    saveCloudEtag(newEtag);
  }
}

// Ù…Ø­Ø§ÙˆÙ„Ø© Ø¯ÙØ¹ Ù…Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© + Ø¯Ù…Ø¬ Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø§Ø±Ø¶
async function firebasePushRetry(maxTries=4){
  let lastErr = null;

  for(let i=1;i<=maxTries;i++){
    try{
      await firebasePushOnce();
      return true;
    }catch(e){
      lastErr = e;

      // âœ… ØªØ¹Ø§Ø±Ø¶: Ø§Ø³Ø­Ø¨ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ© (Ù…Ù† body) ÙˆØ§Ø¯Ù…Ø¬ Ø«Ù… Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
      if(e && e.code === "etag_mismatch"){
        const remoteRows = (extractRowsFromCloud(e.remote)||[]).map(normalizeRowForMerge).filter(Boolean);
        const remoteEtag = e.etag || null;

        cloudEtag = remoteEtag || cloudEtag || null;
        saveCloudEtag(cloudEtag);

        // Ø¯Ù…Ø¬ Ø°ÙƒÙŠ: Ø§Ù„Ù…Ø­Ù„ÙŠ + Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ
        data = mergeRows(data, remoteRows);
        saveLocalBackup();
        try{ render(); }catch{}
        continue; // Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ÙÙˆØ±Ù‹Ø§
      }

      // ÙÙŠ Ø­Ø§Ù„ Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ù†Øª Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
      if(!navigator.onLine) throw e;

      // backoff Ø¨Ø³ÙŠØ·
      await new Promise(r=>setTimeout(r, 450*i));
    }
  }

  throw lastErr || new Error("Firebase push failed");
}

// Ø¯ÙØ¹ ÙÙˆØ±ÙŠ (ÙŠÙØ³ØªØ¯Ø¹Ù‰ Ø¹Ù†Ø¯ Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„)
function scheduleSyncPush(delayMs=600){
  if(syncTimer) clearTimeout(syncTimer);
  syncTimer = setTimeout(()=>syncPushNow(), delayMs);
}

async function syncPushNow(){
  saveLocalBackup();
  markPendingSync(true);

  if(!navigator.onLine){
    setSyncState("offline");
    return;
  }

  try{
    setSyncState("saving");
    await firebasePushRetry(3);
    lastSyncAt = nowHHMM();
    setSyncState("ok");
    markPendingSync(false);
    render();
  }catch(e){
    setSyncState("fail");
    // Ù†ØªØ±Ùƒ pending = true Ù„ÙŠÙØ¹Ø§Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ø§Ø­Ù‚Ù‹Ø§
    try{ showToast("ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase", String(e?.message || e), "err"); }catch{}
  }
}

// Ø³Ø­Ø¨ ÙŠØ¯ÙˆÙŠ Ù…Ù† Firebase (Restore)
async function syncPullNow(opts={}){
  const silent = !!opts.silent;
  const fromLive = !!opts.fromLive;
  if(!navigator.onLine){
    setSyncState("offline");
    if(!silent) try{ showToast("Ø£Ù†Øª Ø£ÙˆÙÙ„Ø§ÙŠÙ†", "Ø´ØºÙ‘Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø«Ù… Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©", "warn"); }catch{}
    return;
  }

  try{
    setSyncState("saving");

    const remote = await firebasePull(); // âœ… ÙŠÙØ­Ø¯Ù‘Ø« cloudEtag Ø£ÙŠØ¶Ù‹Ø§

    if(hasPendingSync()){
      // âœ… Stage 2: Ø¯Ù…Ø¬ Ø¨Ø¯Ù„ Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ (ÙŠØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ ØªØ¹Ø¯ÙŠÙ„Ø§ØªÙƒ Ø§Ù„Ø£ÙˆÙÙ„Ø§ÙŠÙ†)
      const local = Array.isArray(data) ? data : loadLocalBackup();
      data = mergeRows(local, remote);
      saveLocalBackup();
      render();

      // Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ù…Ø¬: Ø§Ø¯ÙØ¹ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù„Ù„Ø³Ø­Ø§Ø¨Ø© Ù„ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ø¬Ù…ÙŠØ¹
      await firebasePushRetry(4);
      lastSyncAt = nowHHMM();
      setSyncState("ok");
      markPendingSync(false);
      render();

      if(!silent) try{ showToast("âœ… ØªÙ… Ø§Ù„Ø¬Ù„Ø¨ + Ø§Ù„Ø¯Ù…Ø¬", "ØªÙ…Øª Ù…Ø²Ø§Ù…Ù†Ø© ØªØ¹Ø¯ÙŠÙ„Ø§ØªÙƒ Ù…Ø¹ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©", "ok"); }catch{}
      return;
    }

    // Ù„Ø§ ÙŠÙˆØ¬Ø¯ pending: Ø­Ù…Ù‘Ù„ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© ÙƒÙ…Ø§ Ù‡ÙŠ
    data = Array.isArray(remote) ? remote : [];
    saveLocalBackup();
    lastSyncAt = nowHHMM();
    setSyncState("ok");
    render();
    if(!silent) try{ showToast("âœ… ØªÙ… Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹", "ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©", "ok"); }catch{}
  }catch(e){
    setSyncState("fail");
    if(!silent) try{ showToast("ØªØ¹Ø°Ø± Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù…Ù† Firebase", String(e?.message || e), "err"); }catch{}
  }
}


// Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©: Ø¥Ù† ÙƒØ§Ù† Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¹Ø¯ÙŠÙ„ Ù…Ø­Ù„ÙŠ Ù…Ø¹Ù„Ù‘Ù‚ØŒ Ø§Ø³Ø­Ø¨ Ù…Ù† Firebase.
// Ø¥Ø°Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¹Ù„Ù‘Ù‚ (Ø¹Ù…Ù„Øª Ø£ÙˆÙÙ„Ø§ÙŠÙ†)ØŒ Ù†ÙØ¨Ù‚ÙŠ Ø§Ù„Ù…Ø­Ù„ÙŠ ÙˆÙ†Ø­Ø§ÙˆÙ„ Ø¯ÙØ¹Ù‡ ÙÙˆØ± ØªÙˆÙØ± Ø§Ù„Ù†Øª.
async function initialLoad(){
  const local = loadLocalBackup();

  if(!navigator.onLine){
    setSyncState("offline");
    data = local;
    return;
  }

  try{
    setSyncState("saving");

    const remote = await firebasePull(); // âœ… ÙŠØ­Ø¯Ù‘Ø« ETag

    if(hasPendingSync()){
      // âœ… Ù„Ø¯ÙŠÙ†Ø§ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ø­Ù„ÙŠØ©: Ø§Ø¯Ù…Ø¬ Ø«Ù… Ø§Ø¯ÙØ¹ (Ø¨Ø¯Ù„ overwrite)
      data = mergeRows(local, remote);
      saveLocalBackup();

      await firebasePushRetry(4);
      lastSyncAt = nowHHMM();
      setSyncState("ok");
      markPendingSync(false);
      return;
    }

    // Ù„Ø§ ÙŠÙˆØ¬Ø¯ pending: Ø®Ø° Ø§Ù„Ø³Ø­Ø§Ø¨Ø©
    data = Array.isArray(remote) ? remote : [];
    saveLocalBackup();
    lastSyncAt = nowHHMM();
    setSyncState("ok");
    return;

  }catch(e){
    setSyncState("fail");
    // fallback: Ø§Ù„Ù…Ø­Ù„ÙŠ
    data = local;
    if(!silent) try{ showToast("ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase", "ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©", "warn"); }catch{}
    return;
  }
}


// Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¹ÙˆØ¯Ø© Ø§Ù„Ù†Øª: Ø£Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ù† ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ pending
function onOnlineMaybeSync(){
  if(hasPendingSync()){
    scheduleSyncPush(0);
  }else{
    // Ù„Ø§ ÙŠÙˆØ¬Ø¯ pending: ÙÙ‚Ø· Ø­Ø¯Ù‘Ø« Ø§Ù„Ø´ÙŠØ¨
    setSyncState(syncState);
  }
}

window.addEventListener("online", onOnlineMaybeSync);
window.addEventListener("offline", ()=> setSyncState("offline"));

// Watchdog: Ø¨Ø¹Ø¶ Ø§Ù„Ù‡ÙˆØ§ØªÙ Ù„Ø§ ØªÙØ·Ù„Ù‚ online Ø¨Ø´ÙƒÙ„ Ù…ÙˆØ«ÙˆÙ‚
setInterval(()=>{
  if(navigator.onLine && hasPendingSync() && syncState !== "saving"){
    scheduleSyncPush(0);
  }
}, 15000);

const SETTINGS_KEY = "subs_dashboard_actions_modal_settings_v2";

const CURRENCY_KEY = "subs_currency_v1";
let data = [];
let editingId = null;

/* ===== Utils ===== */
function todayISO(){
  const d=new Date(); d.setHours(0,0,0,0);
  return d.toISOString().slice(0,10);
}
function toDate(iso){
  const d=new Date(iso+"T00:00:00"); d.setHours(0,0,0,0);
  return d;
}
function addMonths(dateISO, m){
  const d=toDate(dateISO);
  const day=d.getDate();
  d.setMonth(d.getMonth()+m);
  if(d.getDate() < day) d.setDate(0);
  return d.toISOString().slice(0,10);
}
function normalizeEmail(e){ return (e||"").trim().toLowerCase(); }
function validateEmail(e){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e); }
function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}
function daysLeft(endISO){
  const now=toDate(todayISO());
  const end=toDate(endISO);
  return Math.round((end-now)/(1000*60*60*24));
}


function getCurrency(){
  try{
    const v = localStorage.getItem(CURRENCY_KEY);
    return v || "DZD";
  }catch{ return "DZD"; }
}
function setCurrency(v){
  try{ localStorage.setItem(CURRENCY_KEY, v || "DZD"); }catch{}
}
function currencyLabel(code){
  const map = {DZD:"Ø¯Ø¬", USD:"$", EUR:"â‚¬"};
  return map[code] || code;
}

function getStoredAlertDays(){
  try{
    const s = JSON.parse(localStorage.getItem(SETTINGS_KEY)||"{}");
    const a = Number(s.alertDays);
    return (a && a>0) ? a : 7;
  }catch{ return 7; }
}
function setStoredAlertDays(n){
  localStorage.setItem(SETTINGS_KEY, JSON.stringify({alertDays:n}));
}
function getAlertDaysFromForm(){
  const n = Number($("alertDays").value);
  return (n && n>0) ? n : 7;
}
function status(endISO, alertDays){
  const left=daysLeft(endISO);
  if(left < 0) return {key:"expired", label:"Ù…Ù†ØªÙ‡ÙŠ", cls:"err", left};
  if(left <= alertDays) return {key:"expiring", label:"Ù‚Ø±ÙŠØ¨ ÙŠÙ†ØªÙ‡ÙŠ", cls:"warn", left};
  return {key:"active", label:"ÙØ¹Ù‘Ø§Ù„", cls:"ok", left};
}

/* ===== Storage ===== */
async function load(){
  await initialLoad();
}


function save(){
  // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ + Ù…Ø²Ø§Ù…Ù†Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
  saveLocalBackup();
  scheduleSyncPush(0);
}


/* ===== Modals ===== */
function openModal(id){ $(id).setAttribute("aria-hidden","false"); }
function closeModal(id){ $(id).setAttribute("aria-hidden","true"); }
function closeAllModals(){
  ["formModal","backupModal","pasteModal","rowActionsModal","syncModal","authModal"].forEach((m)=>{ try{ closeModal(m); }catch{} });
}

["formModal","backupModal","pasteModal","rowActionsModal","syncModal","authModal"].forEach(mid=>{
  const el = $(mid);
  if(!el) return;
  el.addEventListener("click",(e)=>{ if(e.target.id===mid) closeModal(mid); });
});

document.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closeAllModals(); });

function vibrateLight(){ try{ if (navigator.vibrate) navigator.vibrate(20); }catch{} }

/* ===== Toast + Haptics ===== */
let toastTimer = null;

function haptic(type="light"){
  try{
    if(!navigator.vibrate) return;
    if(type==="light") navigator.vibrate(12);
    else if(type==="ok") navigator.vibrate([12, 30, 12]);
    else if(type==="fail") navigator.vibrate([28, 40, 28]);
    else navigator.vibrate(15);
  }catch{}
}

function showToast(message, detail="", kind="warn"){
  const t = document.getElementById("toast");
  if(!t) return;

  t.className = `toast ${kind}`;
  t.innerHTML = `
    <span class="ico">${kind==="err" ? "âŒ" : kind==="ok" ? "âœ…" : "âš ï¸"}</span>
    <div>
      <div class="msg">${message}</div>
      ${detail ? `<div class="sub">${detail}</div>` : ``}
    </div>
  `;

  clearTimeout(toastTimer);
  t.classList.add("show");
  toastTimer = setTimeout(()=> t.classList.remove("show"), 2200);
}

/* =========================================================
   âœ… Undo / Backup (Ø£Ø¨Ø³Ø· + Ø£ÙƒØ«Ø± Ø£Ù…Ø§Ù†)
   - Ù„Ù‚Ø·Ø© ÙˆØ§Ø­Ø¯Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø°Ù
   - Toast ÙÙŠÙ‡ Ø²Ø± "ØªØ±Ø§Ø¬Ø¹" Ù„Ù…Ø¯Ø© 7 Ø«ÙˆØ§Ù†ÙŠ
========================================================= */
const UNDO_BACKUP_KEY = "subs_undo_backup_v1";

function makeUndoSnapshot(reason="delete"){
  try{
    const payload = { reason, at: Date.now(), data: Array.isArray(data) ? data : [] };
    localStorage.setItem(UNDO_BACKUP_KEY, JSON.stringify(payload));
    return true;
  }catch(e){ return false; }
}
function getUndoSnapshot(){
  try{
    const raw = localStorage.getItem(UNDO_BACKUP_KEY);
    if(!raw) return null;
    const j = JSON.parse(raw);
    if(!j || !Array.isArray(j.data)) return null;
    return j;
  }catch(e){ return null; }
}
function clearUndoSnapshot(){ try{ localStorage.removeItem(UNDO_BACKUP_KEY); }catch{} }

function showUndoToast(title, detail, onUndo){
  const t = document.getElementById("toast");
  if(!t) return;

  t.className = `toast warn`;
  t.innerHTML = `
    <span class="ico">ğŸ—‘ï¸</span>
    <div>
      <div class="msg">${title}</div>
      ${detail ? `<div class="sub">${detail}</div>` : ``}
    </div>
    <button class="action" id="toastUndoBtn" type="button">â†©ï¸ ØªØ±Ø§Ø¬Ø¹</button>
  `;

  clearTimeout(toastTimer);
  t.classList.add("show");

  const btn = document.getElementById("toastUndoBtn");
  if(btn){
    btn.onclick = ()=>{
      try{ onUndo && onUndo(); }catch{}
      t.classList.remove("show");
    };
  }

  toastTimer = setTimeout(()=> t.classList.remove("show"), 7000);
}

function restoreFromUndo(){
  const snap = getUndoSnapshot();
  if(!snap){
    haptic("fail");
    showToast("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø®Ø© Ù„Ù„ØªØ±Ø§Ø¬Ø¹", "", "err");
    return;
  }
  data = snap.data;
  clearUndoSnapshot();
  save();
  render();
  haptic("ok");
  showToast("âœ… ØªÙ… Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¨Ù†Ø¬Ø§Ø­", "", "ok");
}
/* ===== Ù†Ù‡Ø§ÙŠØ© Undo ===== */

/* ===== Form modal ===== */
function resetForm(){
  $("name").value="";
  $("email").value="";
  $("quickPlan").value="";
  $("months").value="";
  $("price").value="";
  $("currency").value=getCurrency();
  $("price").value="";
  $("start").value=todayISO();
  $("alertDays").value=getStoredAlertDays();
  editingId=null;
  $("formTitle").textContent="Ø¥Ø¶Ø§ÙØ© Ø§Ø´ØªØ±Ø§Ùƒ";
}
function fillForm(rec){
  editingId = rec.id;
  $("formTitle").textContent="ØªØ¹Ø¯ÙŠÙ„ Ø§Ø´ØªØ±Ø§Ùƒ";
  $("name").value = rec.name || "";
  $("email").value = rec.email || "";
  $("months").value = rec.months || "";
  $("price").value = (rec.price ?? "");
  $("currency").value = rec.currency || getCurrency();
  $("price").value = (rec.price ?? "") === 0 ? "" : (rec.price ?? "");
  $("start").value = rec.start || todayISO();
  $("quickPlan").value = ["1","3","6","12"].includes(String(rec.months)) ? String(rec.months) : "";
  $("alertDays").value = getStoredAlertDays();
}

$("openAdd").onclick = ()=>{ resetForm(); openModal("formModal"); };
$("closeForm").onclick = ()=> closeModal("formModal");
$("cancelBtn").onclick = ()=> closeModal("formModal");

$("quickPlan").onchange = ()=>{ const v = $("quickPlan").value; if(v) $("months").value = v; };

/* ===== Backup modal ===== */
$("openBackup").onclick = ()=>{
  openModal("backupModal");
  try{
    const snap = getUndoSnapshot();
    const b = $("restoreLastDeleteBtn");
    if(b){ b.disabled = !snap; b.style.opacity = snap ? "1" : ".55"; }
  }catch{}
};
$("closeBackup").onclick = ()=> closeModal("backupModal");
$("closeBackup2").onclick = ()=> closeModal("backupModal");

/* âœ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¢Ø®Ø± Ø­Ø°Ù Ù…Ù† Ù†Ø§ÙØ°Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ */
const __restoreBtn = $("restoreLastDeleteBtn");
if(__restoreBtn){
  __restoreBtn.onclick = ()=>{
    restoreFromUndo();
    closeModal("backupModal");
  };
}


/* ===== Sync modal ===== */
$("openSync").onclick = ()=>{ try{ const inp = $("roomCode"); if(inp) inp.value = getRoomCode(); }catch{} openModal("syncModal"); };

/* ===== Shared Room Code (Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø´ØªØ±ÙƒØ©) ===== */
(function bindRoomCode(){
  const inp = $("roomCode");
  if(!inp) return;
  try{ inp.value = getRoomCode(); }catch{}
  inp.addEventListener("change", ()=>{
    setRoomCode(inp.value);
    cloudEtag = loadCloudEtag(); // âœ… ETag Ø®Ø§Øµ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù€ Room
    inp.value = getRoomCode();
    try{ showToast("âœ… ØªÙ… Ø­ÙØ¸ ÙƒÙˆØ¯ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©", inp.value, "ok"); }catch{}
    try{ restartLiveIfNeeded && restartLiveIfNeeded(); }catch{}
  });
})();

// ===== Totals (ğŸ’° Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹) =====
function getFilteredRows(){
  const q = ($("search").value||"").trim().toLowerCase();
  return activeOnly(data||[]).filter(r=>{
    if(!q) return true;
    return (r.name||"").toLowerCase().includes(q) || (r.email||"").toLowerCase().includes(q);
  });
}

function computeTotalsGroups(list){
  const groups = {};
  for(const r of (list||[])){
    if(r && (r.deleted || r._deleted)) continue;
    const c = r.currency || getCurrency();
    const p = Number(r.price ?? 0);
    if(!Number.isFinite(p) || p<=0) continue;
    groups[c] = (groups[c]||0) + p;
  }
  return groups;
}

function groupsToLines(groups){
  const keys = Object.keys(groups);
  if(keys.length===0) return ["0"];
  return keys.map(k=>{
    const v = groups[k];
    const num = v.toFixed(2).replace(/\.00$/,"");
    return `${num} ${currencyLabel(k)}`;
  });
}

function renderTotalsModal(){
  const box = $("totalsBody");
  if(!box) return;
  const filtered = getFilteredRows();
  const gShown = computeTotalsGroups(filtered);
  const gAll = computeTotalsGroups(data||[]);

  const shownLines = groupsToLines(gShown);
  const allLines = groupsToLines(gAll);

  box.innerHTML = `
    <div style="font-weight:900;margin-bottom:8px">ğŸ‘ï¸ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶</div>
    <div style="line-height:1.9">${shownLines.map(x=>`â€¢ ${escapeHtml(x)}`).join("<br>")}</div>
    <div style="height:1px;background:rgba(255,255,255,.10);margin:12px 0"></div>
    <div style="font-weight:900;margin-bottom:8px">ğŸ“¦ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„</div>
    <div style="line-height:1.9">${allLines.map(x=>`â€¢ ${escapeHtml(x)}`).join("<br>")}</div>
  `;
}

$("openTotals").onclick = ()=>{
  renderTotalsModal();
  openModal("totalsModal");
};
$("closeTotalsX").onclick = ()=> closeModal("totalsModal");
$("closeTotals").onclick  = ()=> closeModal("totalsModal");

$("closeSyncX").onclick = ()=> closeModal("syncModal");
$("closeSync").onclick  = ()=> closeModal("syncModal");
/* ===== Auth modal ===== */
$("openAuth").onclick = ()=>{
  if(!authReady) initAuth();
  openModal("authModal");
  updateAuthUI();
};

/* ===== Paste modal ===== */
$("openPasteFromBackup").onclick = ()=>{ $("pasteArea").value=""; openModal("pasteModal"); };
$("closePaste").onclick = ()=> closeModal("pasteModal");
$("cancelPaste").onclick = ()=> closeModal("pasteModal");

/* ===== Top actions ===== */
$("search").addEventListener("input", render);

/* âœ… Ø­Ø°Ù Ø§Ù„ÙƒÙ„: Ø§Ù„Ø¢Ù† Ù…Ø¹ Undo */
async function openShareModal(text){
  try{
    const enc = encodeURIComponent(text || "");
    const wa = document.getElementById("shareWhatsApp");
    const tg = document.getElementById("shareTelegram");
    const em = document.getElementById("shareEmail");
    if(wa) wa.href = `https://wa.me/?text=${enc}`;
    if(tg) tg.href = `https://t.me/share/url?text=${enc}`;
    // Gmail/Email: use mailto (Gmail will handle it if installed / user selects)
    const subject = encodeURIComponent("ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª");
    if(em) em.href = `mailto:?subject=${subject}&body=${enc}`;
    const note = document.getElementById("shareNote");
    if(note) note.textContent = "âœ… Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©. ÙŠÙ…ÙƒÙ†Ùƒ Ø£ÙŠØ¶Ù‹Ø§ Ø§Ù„Ù†Ø³Ø®.";
    openModal();
  }catch(e){
    try{ showToast("ØªØ¹Ø°Ø± ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©", String(e?.message||e), "err"); }catch{}
  }
}

// ===== Print + Share =====
function formatMoney(r){
  const p = (r && r.price != null) ? Number(r.price) : 0;
  const c = (r && r.currency) ? r.currency : (typeof getCurrency === "function" ? getCurrency() : "");
  const sym = (typeof currencyLabel === "function") ? currencyLabel(c) : c;
  if(!Number.isFinite(p)) return "";
  return `${p} ${sym}`.trim();
}

function buildShareText(list){
  const lines = [];
  lines.push("Ø§Ù„Ø§Ø³Ù…,Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„,Ø§Ù„Ù…Ø¯Ø©,Ø§Ù„Ø³Ø¹Ø±,Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©,Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡,Ø§Ù„Ø­Ø§Ù„Ø©");
  const alertDays = (typeof getStoredAlertDays === "function") ? getStoredAlertDays() : 7;
  for(const r of (list||[])){
    const st = (typeof status === "function") ? status(r.end, alertDays) : {label:""};
    const row = [
      (r.name||"").replaceAll(",", " "),
      (r.email||"").replaceAll(",", " "),
      `${r.months||""}`,
      formatMoney(r).replaceAll(",", " "),
      (r.start||""),
      (r.end||""),
      (st.label||"")
    ];
    lines.push(row.join(","));
  }
  return lines.join("\n");
}

async function doShare(){
  try{
    const q = ($("search").value||"").trim().toLowerCase();
    const list = activeOnly(data||[]).filter(r=>{
      if(!q) return true;
      return (r.name||"").toLowerCase().includes(q) || (r.email||"").toLowerCase().includes(q);
    });
    if(!list.length){
      showToast("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©", "", "warn");
      return;
    }
    const text = buildShareText(list);
    const title = "ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª";

    if(navigator.share){
      navigator.share({ title, text })
        .then(()=> showToast("ØªÙ…Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© âœ…", "", "ok"))
        .catch(()=>{}); // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ù„ØºÙ‰
      return;
    }

    // fallback: copy to clipboard
    navigator.clipboard.writeText(text)
      .then(()=> showToast("ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…", "ØªÙ… Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©", "ok"))
      .catch(()=> showToast("ØªØ¹Ø°Ø± Ø§Ù„Ù†Ø³Ø®", "", "err"));
  }catch(e){
    showToast("ÙØ´Ù„Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©", String(e?.message||e), "err");
  }
}

function doPrint(){
  try{
    const d = new Date();
    const meta = document.getElementById("printMeta");
    const total = (typeof data !== "undefined") ? activeOnly(data).length : 0;
    const shown = (()=>{
      const q = ($("search").value||"").trim().toLowerCase();
      if(!q) return total;
      return activeOnly(data||[]).filter(r=> (r.name||"").toLowerCase().includes(q) || (r.email||"").toLowerCase().includes(q)).length;
    })();
    if(meta){
      meta.textContent = `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${d.toLocaleDateString()} â€” Ø§Ù„ÙˆÙ‚Øª: ${d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} â€” Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total} â€” Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶: ${shown}`;
    }
    window.print();
  }catch(e){
    showToast("ÙØ´Ù„Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©", String(e?.message||e), "err");
  }
}

$("clearBtn").onclick = ()=>{
  if(!activeOnly(data).length){
    showToast("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø­Ø°Ù", "", "warn");
    return;
  }
  if(!confirm("Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ")) return;

  makeUndoSnapshot("clear_all");  // âœ… Ù„Ù‚Ø·Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø°Ù

  const count = activeOnly(data).length;
  const __now = Date.now();
  data = (data||[]).map(r=>{
    if(!r || typeof r !== 'object') return r;
    if(r.deleted) return r;
    return { ...r, deleted:true, updatedAt: __now, updatedBy: getDeviceId(),
    updatedByName: getDeviceLabel() };
  });
  save();
  render();

  showUndoToast("ØªÙ… Ø­Ø°Ù Ø§Ù„ÙƒÙ„", `Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${count}`, ()=> restoreFromUndo());
  haptic("fail");
};

$("printBtn").onclick = ()=> doPrint();
$("shareBtn").onclick = ()=> doShare();


/* ===== Upsert record (merge by email) ===== */
function upsert(rec){
  const idxByEmail = data.findIndex(r=>normalizeEmail(r.email)===normalizeEmail(rec.email));

  if(editingId){
    const idxById = data.findIndex(r=>r.id===editingId);
    if(idxById>=0){
      if(idxByEmail>=0 && idxByEmail!==idxById){
        data[idxByEmail] = {...data[idxByEmail], ...rec, id:data[idxByEmail].id};
        data.splice(idxById,1);
      }else{
        data[idxById] = {...data[idxById], ...rec, id:editingId};
      }
      return;
    }
  }
  if(idxByEmail>=0){
    data[idxByEmail] = {...data[idxByEmail], ...rec, id:data[idxByEmail].id};
  }else{
    data.unshift(rec);
  }
}

function handleSaveClick(){
  const name = $("name").value.trim();
  const email = normalizeEmail($("email").value);
  const months = Number($("months").value);
  const start = $("start").value;
  const alertDays = getAlertDaysFromForm();

  const priceRaw = String($("price").value || "").trim().replace(",", ".");
  const price = priceRaw === "" ? NaN : Number(priceRaw);

  const currencySel = $("currency").value;
  const currency = (currencySel || getCurrency() || "DZD").trim();

  if(!name) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…");
  if(!email || !validateEmail(email)) return alert("Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ØºÙŠØ± ØµØ­ÙŠØ­");
  if(!start) return alert("Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©");
  if(!months || months < 1) return alert("Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ù‡Ø±");
  if(!isFinite(price) || price < 0) return alert("Ø§Ù„Ø³Ø¹Ø± ØºÙŠØ± ØµØ­ÙŠØ­");

  // Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„
  const existsIndex = data.findIndex(r => !r.deleted && normalizeEmail(r.email) === email);
  const isDuplicate = existsIndex >= 0 && (!editingId || data[existsIndex].id !== editingId);
  if(isDuplicate){
    haptic("fail");
    showToast("Ø§Ù„Ø§ÙŠÙ…ÙŠÙ„ Ù…ÙƒØ±Ø±", email, "err");
    try{ $("email").focus(); }catch{}
    return;
  }

  setStoredAlertDays(alertDays);
  setCurrency(currency);

  const end = addMonths(start, months);
  const rec = {
    id: editingId || (Date.now()+"_"+Math.random().toString(16).slice(2)),
    name,
    email,
    months,
    price,
    currency,
    start,
    end,
    deleted: false,
    updatedAt: Date.now(),
    updatedBy: getDeviceId(),
    updatedByName: getDeviceLabel()
  };

  upsert(rec);
  save();
  render();
  closeModal("formModal");
}

(function bindSaveButton(){
  const btn = $("saveBtn");
  if(!btn) return;
  const fire = (e)=>{ try{ e.preventDefault(); }catch{} handleSaveClick(); };
  btn.addEventListener("click", fire);
  btn.addEventListener("touchend", (e)=>{ fire(e); }, {passive:false});
})();

/* ===== Backup helpers ===== */
function downloadFile(filename, content, mime){
  const blob=new Blob([content],{type:mime});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download=filename;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}
function buildBackupPayload(){
  return { version: 2, exportedAt: new Date().toISOString(), alertDays: getStoredAlertDays(), data: activeOnly(data) };
}

$("exportJsonBtn").onclick = ()=>{
  const payload = buildBackupPayload();
  downloadFile("subscriptions_backup.json", JSON.stringify(payload,null,2), "application/json;charset=utf-8");
};

$("importFileBtn").onclick = ()=> $("fileInput").click();
$("fileInput").addEventListener("change", async ()=>{
  const f=$("fileInput").files[0];
  $("fileInput").value="";
  if(!f) return;
  importFromText(await f.text());
});

$("doPasteImport").onclick = ()=> importFromText($("pasteArea").value);

function importFromText(text){
  const raw=(text||"").trim();
  if(!raw) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ JSON");

  let incoming;
  try{ incoming = JSON.parse(raw); }
  catch{ alert("JSON ØºÙŠØ± ØµØ§Ù„Ø­"); return; }

  const importedData = Array.isArray(incoming) ? incoming : incoming.data;
  if(!Array.isArray(importedData)){ alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª"); return; }

  if(incoming && typeof incoming.alertDays==="number" && incoming.alertDays>0){
    setStoredAlertDays(incoming.alertDays);
  }

  let added=0, updated=0;
  for(const r of importedData){
    if(!r || !r.email) continue;
    const email = normalizeEmail(r.email);
    if(!email || !validateEmail(email)) continue;
    const months = Number(r.months||1);

    const currency = (r.currency || getCurrency());
    const price = Number((r.price ?? 0) || 0);
    const start = r.start || todayISO();
    const end = r.end || addMonths(start, months);

    const rec = {
      id: r.id || (Date.now()+"_"+Math.random().toString(16).slice(2)),
      name: (r.name||"").trim(),
      email, months, price, currency, start, end,
      deleted: false,
      updatedAt: Date.now(),
      updatedBy: getDeviceId(),
    updatedByName: getDeviceLabel()
    };

    const idx = data.findIndex(x=>normalizeEmail(x.email)===email);
    if(idx>=0){ data[idx] = {...data[idx], ...rec, id:data[idx].id}; updated++; }
    else { data.unshift(rec); added++; }
  }

  save(); render();
  closeModal("pasteModal");
  alert(`ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ âœ…\nØ¥Ø¶Ø§ÙØ©: ${added}\nØªØ­Ø¯ÙŠØ«: ${updated}`);
}

$("exportCsvBtn").onclick = ()=>{
  const header=["name","email","months","price","start","end"];
  const lines=[header.join(",")];
  for(const r of data){
    lines.push([csvCell(r.name),csvCell(r.email),csvCell(r.months),csvCell(r.price ?? 0),csvCell(r.start),csvCell(r.end)].join(","));
  }
  downloadFile("subscriptions.csv", lines.join("\n"), "text/csv;charset=utf-8");
};
function csvCell(v){
  const s=String(v??"");
  if(/["\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
  return s;
}

/* ===== Actions Modal (Ù„Ù„Ø¬Ø¯ÙˆÙ„ ÙÙ‚Ø·) ===== */
let currentRowId = null;

function openRowActions(id){
  currentRowId = id;
  const rec = data.find(x => x.id === id);
  if(!rec) return;
  const by = rec.updatedByName || (rec.updatedBy ? ("Ø¬Ù‡Ø§Ø² " + String(rec.updatedBy).slice(-4).toUpperCase()) : "â€”");
  $("rowActionsHint").textContent = `${rec.name} â€” ${rec.email} â€” Ø¢Ø®Ø± ØªØ¹Ø¯ÙŠÙ„: ${by}`;
  openModal("rowActionsModal");
  vibrateLight();
}
function closeRowActions(){
  closeModal("rowActionsModal");
  currentRowId = null;
}
$("closeRowActionsX").onclick = closeRowActions;
$("closeRowActions").onclick  = closeRowActions;

$("actEdit").onclick = ()=>{
  const rec = data.find(x => x.id === currentRowId);
  if(!rec) return;
  closeRowActions();
  fillForm(rec);
  openModal("formModal");
};

$("actExtend").onclick = ()=>{
  const rec = data.find(x => x.id === currentRowId);
  if(!rec) return;
  rec.end = addMonths(rec.end, Number(rec.months));
  rec.deleted = false;
  rec.updatedAt = Date.now();
  rec.updatedBy = getDeviceId();
  rec.updatedByName = getDeviceLabel();
  save();
  render();
  closeRowActions();
};

/* âœ… Ø­Ø°Ù Ø³Ø¬Ù„: Ø§Ù„Ø¢Ù† Ù…Ø¹ Undo */
$("actDelete").onclick = ()=>{
  const rec = data.find(x => x.id === currentRowId);
  if(!rec) return;

  if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ")) return;

  makeUndoSnapshot("delete_one"); // âœ… Ù„Ù‚Ø·Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø°Ù

  rec.deleted = true;
  rec.updatedAt = Date.now();
  rec.updatedBy = getDeviceId();
  rec.updatedByName = getDeviceLabel();
  save();
  render();
  closeRowActions();

  showUndoToast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„", rec.email || "", ()=> restoreFromUndo());
  haptic("fail");
};

$("actCopyEmail").onclick = async ()=>{
  const rec = data.find(x => x.id === currentRowId);
  if(!rec) return;

  const text = rec.email || "";
  try{
    await navigator.clipboard.writeText(text);
    vibrateLight();
    alert("âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„");
  }catch{
    const tmp = document.createElement("textarea");
    tmp.value = text;
    document.body.appendChild(tmp);
    tmp.select();
    document.execCommand("copy");
    tmp.remove();
    vibrateLight();
    alert("âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„");
  }
};

/* ===== Sync modal buttons ===== */
$("syncBackupDownload").onclick = ()=>{ try{ const inp=$("roomCode"); if(inp) setRoomCode(inp.value); }catch{} syncPushNow(); };
$("syncRestorePick").onclick = ()=>{ try{ const inp=$("roomCode"); if(inp) setRoomCode(inp.value); }catch{} syncPullNow(); };
// Live Sync toggle (Stage 3)
const __liveBtn = document.getElementById("liveToggleBtn");
if(__liveBtn){
  __liveBtn.onclick = ()=>{
    try{ const inp=$("roomCode"); if(inp) setRoomCode(inp.value); }catch{}
    const on = isLiveEnabled();
    setLiveEnabled(!on);
  };
}
updateLiveBtn();


$("syncBackupShare").onclick = async ()=>{
  const payload = buildBackupPayload();
  const text = JSON.stringify(payload, null, 2);
  const blob = new Blob([text], {type:"application/json"});
  const file = new File([blob], "backup.json", {type:"application/json"});

  try{
    if(navigator.share && navigator.canShare && navigator.canShare({files:[file]})){
      await navigator.share({title:"Backup", text:"backup.json", files:[file]});
      vibrateLight();
      return;
    }
  }catch{}

  downloadFile("backup.json", text, "application/json;charset=utf-8");
  alert("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ù (backup.json) ÙˆØªÙ†Ø²ÙŠÙ„Ù‡");
};

/* ===== Table click handling ===== */
$("tbody").addEventListener("click",(e)=>{
  const btn = e.target.closest("button[data-act]");
  if(!btn) return;

  const act = btn.getAttribute("data-act");
  const id  = btn.getAttribute("data-id");

  if(act === "actions"){
    openRowActions(id);
    return;
  }
});

/* ===== Render ===== */


function computeTotalsText(list){
  const groups = {};
  for(const r of (list||[])){
    if(r && (r.deleted || r._deleted)) continue;
    const c = r.currency || getCurrency();
    const p = Number(r.price ?? 0);
    if(!Number.isFinite(p) || p<=0) continue;
    groups[c] = (groups[c]||0) + p;
  }
  const keys = Object.keys(groups);
  if(keys.length === 0) return {text:"0", multi:false};
  if(keys.length === 1){
    const c = keys[0];
    const v = groups[c];
    return {text:`${v.toFixed(2).replace(/\.00$/,"")} ${currencyLabel(c)}`, multi:false};
  }
  // multiple currencies
  const parts = keys.map(k => `${groups[k].toFixed(2).replace(/\.00$/,"")} ${currencyLabel(k)}`);
  return {text: parts.join(" Â· "), multi:true};
}

function render(){
  const q = ($("search").value||"").trim().toLowerCase();
  const tb = $("tbody");
  tb.innerHTML="";

  const alertDays = getStoredAlertDays();

  const allCounts={active:0, expiring:0, expired:0};
  for(const r of activeOnly(data)){
    allCounts[status(r.end, alertDays).key]++;
  }

  const rows = activeOnly(data).filter(r=>{
    if(!q) return true;
    return (r.name||"").toLowerCase().includes(q) || normalizeEmail(r.email).includes(q);
  });

  for(const r of rows){
    const st = status(r.end, alertDays);
    const tr = document.createElement("tr");
    if(st.key==="expired") tr.classList.add("expired-row");
    if(st.key==="expiring") tr.classList.add("expiring-row");

    const leftTxt = st.left < 0 ? `Ø§Ù†ØªÙ‡Ù‰ Ù…Ù†Ø° ${Math.abs(st.left)} ÙŠÙˆÙ…` : `${st.left} ÙŠÙˆÙ…`;

    tr.innerHTML = `
      <td>${escapeHtml(r.name)}</td>
      <td>${escapeHtml(r.email)}</td>
      <td>${r.months} Ø´Ù‡Ø±</td>
      <td>${escapeHtml(formatMoney(r))}</td>
      <td>${r.start}</td>
      <td>${r.end}</td>
      <td>${leftTxt}</td>
      <td><span class="badge ${st.cls}">${st.label}</span></td>
      <td>
        <button class="actionPill" data-act="actions" data-id="${r.id}" type="button">âš¡ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</button>
      </td>
    `;
    tb.appendChild(tr);
  }

  if(rows.length === 0){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="9" style="text-align:center;color:rgba(234,240,255,.70);padding:18px">
      Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§
    </td>`;
    tb.appendChild(tr);
  }

  setSyncState(syncState);

  const bar = document.getElementById("statsBar");
  if(bar){
    
  const sumAll = computeTotalsText(data||[]);
  const sumShown = computeTotalsText(rows||[]);

  const bar = document.getElementById("statsBar");
  if(bar){
    bar.innerHTML = `
      <div class="statChip"><span class="ico">ğŸ‘ï¸</span><span class="k">Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶</span><span class="v">${rows.length}</span></div>
      <div class="statChip"><span class="ico">ğŸ“¦</span><span class="k">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span><span class="v">${activeOnly(data).length}</span></div>
      <div class="statChip"><span class="ico">ğŸ’°</span><span class="k">Ù…Ø¬Ù…ÙˆØ¹</span><span class="v">${escapeHtml(sumAll.text)}</span></div>
      <div class="statChip"><span class="ico">ğŸ§¾</span><span class="k">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶</span><span class="v">${escapeHtml(sumShown.text)}</span></div>
      <div class="statChip ok"><span class="ico">âœ…</span><span class="k">ÙØ¹Ù‘Ø§Ù„</span><span class="v">${allCounts.active}</span></div>
      <div class="statChip warn"><span class="ico">â°</span><span class="k">Ù‚Ø±ÙŠØ¨</span><span class="v">${allCounts.expiring}</span></div>
      <div class="statChip err"><span class="ico">âŒ</span><span class="k">Ù…Ù†ØªÙ‡ÙŠ</span><span class="v">${allCounts.expired}</span></div>
      <div class="statChip sync" id="syncChip"><span class="ico">â˜ï¸</span><span class="k">Ù…Ø²Ø§Ù…Ù†Ø©</span><span class="v" id="syncVal">${getSyncText()}</span></div>
      <div class="statChip sync"><span class="ico">ğŸ‘¥</span><span class="k">ØºØ±ÙØ©</span><span class="v">${escapeHtml(getRoomCode())}</span></div>
    `;
  }
  }
}

/* init */
(async ()=>{
  try{ initAuth(); }catch{}
  await load();
  render();
})();
</script>

<!-- Modal: Auth -->
<div class="modal" id="authModal" aria-hidden="true">
  <div class="box" role="dialog" aria-modal="true">
    <div class="modalHeader">
      <div>
        <h2>ğŸ‘¤ Ø§Ù„Ø­Ø³Ø§Ø¨</h2>
        <div class="hint">Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„/Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø±Ø¨Ø· Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ø¹Ø¯)</div>
      </div>
      <button class="btn" id="closeAuth" type="button" aria-label="Ø¥ØºÙ„Ø§Ù‚">âœ•</button>
    </div>

    <div style="padding:14px 16px">
      <div class="field" style="margin-bottom:10px">
        <label>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</label>
        <input id="authEmail" type="email" inputmode="email" placeholder="name@example.com" autocomplete="email">
      </div>
      <div class="field">
        <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
        <input id="authPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">
      </div>

      <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap">
        <button class="btn primary" id="authLogin" type="button">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        <button class="btn soft" id="authRegister" type="button">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
        <button class="btn danger" id="authLogout" type="button" style="margin-inline-start:auto">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
      </div>

      <div id="authStateText" style="margin-top:10px; font-size:13px; color:var(--muted)">â€”</div>
    </div>
  </div>
</div>

<script>
/* Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± auth Ø¨Ø¹Ø¯ ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ÙÙŠ DOM */
$("closeAuth").onclick = ()=> closeModal("authModal");
$("authLogin").onclick = async ()=>{
  if(!authReady) initAuth();
  const email = ($("authEmail").value || "").trim();
  const pass  = ($("authPass").value || "");
  if(!email || !pass){ haptic("light"); showToast("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", "", "warn"); return; }
  try{
    setSyncState("saving");
    await firebase.auth().signInWithEmailAndPassword(email, pass);
    setSyncState("ok");
    haptic("ok");
    showToast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„", email, "ok");
  }catch(e){
    setSyncState("fail");
    haptic("fail");
    showToast("ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„", String(e?.message || e), "err");
  }
};
$("authRegister").onclick = async ()=>{
  if(!authReady) initAuth();
  const email = ($("authEmail").value || "").trim();
  const pass  = ($("authPass").value || "");
  if(!email || !pass){ haptic("light"); showToast("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", "", "warn"); return; }
  try{
    setSyncState("saving");
    await firebase.auth().createUserWithEmailAndPassword(email, pass);
    setSyncState("ok");
    haptic("ok");
    showToast("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨", email, "ok");
  }catch(e){
    setSyncState("fail");
    haptic("fail");
    showToast("ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨", String(e?.message || e), "err");
  }
};
$("authLogout").onclick = async ()=>{
  if(!authReady) initAuth();
  try{
    setSyncState("saving");
    await firebase.auth().signOut();
    setSyncState("ok");
    haptic("ok");
    showToast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬", "", "ok");
  }catch(e){
    setSyncState("fail");
    haptic("fail");
    showToast("ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬", String(e?.message || e), "err");
  }
};
</script>



<!-- Toast -->
<div id="toast" class="toast" aria-live="polite" aria-atomic="true"></div>

</body>
</html>
